<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rusty Robot Dashboard</title>
    <link rel="stylesheet" href="/static/pico.min.css" />
    <link rel="stylesheet" href="/static/orbit.min.css" />
    <link rel="stylesheet" href="/static/robot.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <main class="container">
      <section>
        <div id="app"></div>
      </section>
      <section>
        <h3>Camera</h3>
        <img id="camera" src="/camera/frame.mjpeg" />
      </section>
    </main>

    <script src="/static/orbit.min.js"></script>

    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>

    <script type="module">
      import { Fragment, render } from "preact";
      import { signal } from "@preact/signals";
      import { useEffect, useRef, useLayoutEffect } from "preact/hooks";
      import { html } from "htm/preact";

      const API_BASE_URL = "http://raspberrypi.local:3000/api";
      const SUB_MENUS = {
        servo: {
          path: "servo",
          orbitButtonClass:
            "orbit-5 shrink-70 from-120 range-120 submenu-buttons",
          orbitAccentClass:
            "orbit-6 grow-1x from-120 range-120 submenu-accents",
          buttons: [
            ["servo.end", "bi-skip-end-circle-fill", 120, 15],
            ["servo.increment", "bi-plus-circle-fill", 150, 15],
            ["servo.decrement", "bi-dash-circle-fill", 180, 15],
            ["servo.start", "bi-skip-start-circle-fill", 210, 15],
          ],
        },

        leds: {
          path: "leds",
          orbitButtonClass: "orbit-5 shrink-70 range-120 submenu-buttons",
          orbitAccentClass: "orbit-6 grow-1x range-120 submenu-accents",
          buttons: [
            ["leds.increment", "bi-plus-circle-fill", 0, 30],
            ["leds.decrement", "bi-dash-circle-fill", 60, 30],
          ],
        },

        motor: {
          path: "motor",
          orbitButtonClass:
            "orbit-5 shrink-70 from-240 range-120 submenu-buttons",
          orbitAccentClass:
            "orbit-6 grow-1x from-240 range-120 submenu-accents",
          buttons: [
            ["motor.forward", "bi-arrow-up-circle-fill", 330, 15],
            ["motor.right", "bi-arrow-right-circle-fill", 300, 15],
            ["motor.left", "bi-arrow-left-circle-fill", 270, 15],
            ["motor.backward", "bi-arrow-down-circle-fill", 240, 15],
          ],
        },
      };

      const mainMenuActive = signal(null);
      const subMenuActive = signal(null);
      const ultrasoundSensor = signal(null);
      const ldrSensor = signal(null);

      const cx = (obj) =>
        Object.entries(obj)
          .filter(([, v]) => v)
          .map(([k]) => k)
          .join(" ");

      function App() {
        const wsRef = useRef(null);

        mainMenuActive.subscribe(() => (subMenuActive.value = null));

        useEffect(() => {
          if (wsRef.current) return; // Prevent double-connection

          requestAnimationFrame(() => {
            wsRef.current = new WebSocket("ws://raspberrypi.local:3000/ws");

            wsRef.current.onopen = () => {
              console.log("WebSocket opened");
            };

            wsRef.current.onmessage = (event) => {
              const msg = JSON.parse(event.data);

              if (msg.Ultrasound) {
                ultrasoundSensor.value = msg.Ultrasound.distance.toFixed(1);
              }

              if (msg.Ldr) {
                ldrSensor.value = msg.Ldr;
              }
            };

            wsRef.current.onerror = (err) => {
              console.error("Websocket error", err);
            };

            wsRef.current.onclose = () => {
              console.log("WebSocket closed");
              wsRef.current = null;
            };
          });

          return () => wsRef.current?.close();
        }, []);

        useLayoutEffect(() => {
          const resize = () => Orbit.resize(".wrapper");

          requestAnimationFrame(() => {
            requestAnimationFrame(resize);
          });

          window.addEventListener("resize", resize);

          return () => {
            window.removeEventListener("resize", resize);
          };
        }, []);

        const handleClick = async (url, actionName, opts = {}) => {
          subMenuActive.value = actionName;

          const method = "post";
          const body = JSON.stringify({ action: actionName, ...opts });
          const headers = new Headers();
          headers.append("Content-Type", "application/json");

          try {
            const response = await fetch(url, {
              method,
              headers,
              body,
            });

            if (!response.ok) {
              console.error("Error processing request", response.status);
              return;
            }

            const result = await response.json();
            console.log(result);
          } catch (error) {
            console.error("Error making request", error);
          }
        };

        return html`
          <div class="wrapper">
            <div class="bigbang x-dev-orbit">
              <div class="orbit-scale">
                <div class="gravity-spot menu-example" style="--o-force: 600px">
                  <${MenuTitle} />
                  <${MainMenu} />
                  <${SubMenu} onClick=${handleClick} />
                  <${MenuCowl} />
                  <${LedGauges} />
                  <${UltrasoundGauge} />
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function MenuTitle() {
        return html`
          <div class="orbit-0">
            <div class="capsule at-center">MENU</div>
          </div>
        `;
      }

      function MainMenuButton({ name }) {
        const handleClick = () => (mainMenuActive.value = name.toLowerCase());

        return html`<o-arc
          class="grow-1x button control-size"
          onClick=${handleClick}
        ></o-arc>`;
      }

      function MainMenuButtons() {
        return html`
          <div class="orbit-3 main-menu">
            ${["leds", "servo", "motor"].map(
              (name) =>
                html`<${MainMenuButton}
                  name=${name}
                  key=${`main-menu-button-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenuLabel({ name }) {
        const handleClick = () => (mainMenuActive.value = name.toLowerCase());

        return html`
          <o-arc class="flip" onClick=${handleClick}> ${name} </o-arc>
        `;
      }

      function MainMenuLabels({ action }) {
        return html`
          <div class="orbit-3 main-menu">
            ${["LEDs", "Servo", "Motor"].map(
              (name) =>
                html`<${MainMenuLabel}
                  action=${action}
                  name=${name}
                  key=${`main-menu-label-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenuAccent({ name }) {
        return html`<o-arc
          class=${cx({
            "accent shrink-65 inner-orbit": true,
            active: mainMenuActive.value === name,
          })}
        ></o-arc>`;
      }

      function MainMenuAccents({ active }) {
        return html`
          <div class="orbit-4">
            ${["leds", "servo", "motor"].map(
              (name) =>
                html`<${MainMenuAccent}
                  active=${active}
                  name=${name}
                  key=${`main-menu-accent-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenu({ active }) {
        return html`
          <${MainMenuButtons} />
          <${MainMenuAccents} />
          <${MainMenuLabels} />
        `;
      }

      function SubMenu({ onClick }) {
        if (!mainMenuActive.value) return html`<${Fragment} />`;

        return html`
          <${SubMenuBuilder}
            name=${mainMenuActive.value}
            config=${SUB_MENUS[mainMenuActive.value]}
            onClick=${onClick}
            active=${subMenuActive.value}
          />
        `;
      }

      function SubMenuBuilder({ name, config, onClick, active }) {
        const url = `${API_BASE_URL}/${config.path}`;

        return html`
          <div class=${`${config.orbitButtonClass}`}>
            ${config.buttons.map(
              ([name, icon, angle, offset]) =>
                html` <${OrbitActionButton}
                  name=${name}
                  icon=${icon}
                  angle=${angle}
                  labelAngle=${angle + offset}
                  onClick=${onClick}
                  url=${url}
                  key=${`orbit-action-button-${name}`}
                />`,
            )}
          </div>

          <div class=${`${config.orbitAccentClass}`}>
            ${config.buttons.map(
              ([name, icon, angle]) =>
                html` <${OrbitActionAccent}
                  active=${active}
                  name=${name}
                  angle=${angle}
                  key=${`orbit-action-accent-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function OrbitActionButton({
        name,
        icon,
        angle,
        labelAngle,
        active,
        url,
        onClick,
      }) {
        const handleMouseDown = () => onClick(url, name);
        const handleMouseUp = () => onClick(url, "motor.stop");

        return html`
          <!-- Button -->
          <o-arc
            class=${cx({
              "outer-orbit": true,
              "grow-1x": true,
              [`angle-${angle}`]: true,
            })}
            onMouseDown=${handleMouseDown}
            onMouseUp=${handleMouseUp}
          ></o-arc>

          <!-- Button Label (Icon) -->
          <div
            class=${cx({
              satellite: true,
              "outer-orbit": true,
              "grow-1x": true,
              [`angle-${labelAngle}`]: true,
            })}
            onMouseDown=${handleMouseDown}
            onMouseUp=${handleMouseUp}
          >
            <div class="capsule">
              <i class=${`bi ${icon}`}></i>
            </div>
          </div>
        `;
      }

      function OrbitActionAccent({ angle, active, name }) {
        return html`
          <o-arc
            class=${cx({
              "shrink-80": true,
              [`angle-${angle}`]: true,
              accent: true,
              active: active === name,
            })}
          ></o-arc>
        `;
      }

      function MenuCowl() {
        return html`
          <!-- Outer ring -->
          <div class="orbit-7 shrink-50" style="z-index: -1;">
            <o-arc
              class="shrink-90 angle-0 inner-orbit darker-gray big-dash"
            ></o-arc>
          </div>

          <!-- Outer ring -->
          <div class="orbit-8 shrink-50" style="z-index: -1;">
            <o-arc
              class="shrink-90 angle-0 inner-orbit darker-gray big-dash"
            ></o-arc>
          </div>

          <!-- Vectors -->
          <div class="orbit-7">
            <div class="vector angle-0"></div>
            <div class="vector angle-120"></div>
            <div class="vector angle-210"></div>
            <div class="vector angle-240"></div>
          </div>

          <!-- Readings labels -->
          <div class="orbit-7 shrink-20 labels">
            <o-arc text-anchor="middle" class="grow-1x angle-15"
              >Neopixel lights</o-arc
            >
            <o-arc text-anchor="middle" class="grow-1x angle-120"
              >Light dependent resistors</o-arc
            >
            <o-arc text-anchor="middle" class="grow-1x angle-180">Servo</o-arc>
            <o-arc text-anchor="middle" class="grow-1x angle-250"
              >Ultrasound distance</o-arc
            >
          </div>
        `;
      }

      function mapRange(value, inMin, inMax, outMin, outMax) {
        return outMin + ((value - inMin) * (outMax - outMin)) / (inMax - inMin);
      }

      function UltrasoundGauge() {
        const SEGMENTS = 18;

        const filledCount = Math.round(
          mapRange(ultrasoundSensor.value, 1, 100, 0, SEGMENTS),
        );

        return html`
          <div class="orbit-9 from-244 range-120 big-dash">
            ${Array.from({ length: SEGMENTS }).map((_, i) => {
              const visualIndex = SEGMENTS - 1 - i;
              const isActive = visualIndex < filledCount;

              let color = "green";
              if (i > 8 && i <= 13) color = "orange";
              if (i > 13) color = "red";

              const klass = `
                vector
                shrink-40
                outer-orbit
                dashed-big
                ${color}
                ${isActive ? "active" : "inner-orbitactive"}
              `;

              return html`
                <div
                  key=${`ultrasound-sensor-gauge-vector-${i}`}
                  class=${klass}
                ></div>
              `;
            })}
          </div>
        `;
      }

      function LedGauges() {
        return html`
          <!-- LDR sensor gauges -->
          <div class="orbit-9 sensor">
            <div class="satellite angle-135 ldr grow-1x">L3</div>
            <div class="satellite angle-165 ldr grow-1x">L2</div>
            <div class="satellite angle-195 ldr active grow-1x">L1</div>
          </div>

          <!-- Servo gauges -->
          <div class="orbit-9 sensor">
            <div class="satellite angle-225">
              <div class="gravity-spot">
                <div class="orbit-0">
                  <div class="satellite">
                    <div class="capsule">30</div>
                  </div>
                </div>
                <div class="orbit-2 shrink-90">
                  <o-progress
                    class="shrink-50 angle-0 white"
                    value="30"
                    max="100"
                    shape="circle"
                  ></o-progress>
                </div>
              </div>
            </div>
          </div>

          <!-- LED gauges -->
          <div class="orbit-9 sensor">
            <div class="satellite angle-15">
              <div class="gravity-spot">
                <div class="orbit-0">
                  <div class="satellite">
                    <div class="capsule">30</div>
                  </div>
                </div>
                <div class="orbit-2 shrink-90">
                  <o-progress
                    class="shrink-50 angle-0 red"
                    value="30"
                    max="255"
                    shape="circle"
                  ></o-progress>
                </div>
              </div>
            </div>
            <div class="satellite angle-45">
              <div class="gravity-spot">
                <div class="orbit-0">
                  <div class="satellite">
                    <div class="capsule">60</div>
                  </div>
                </div>
                <div class="orbit-2 shrink-90">
                  <o-progress
                    class="shrink-50 angle-0 green"
                    value="60"
                    max="255"
                    shape="circle"
                  ></o-progress>
                </div>
              </div>
            </div>
            <div class="satellite angle-75">
              <div class="gravity-spot">
                <div class="orbit-0">
                  <div class="satellite">
                    <div class="capsule">203</div>
                  </div>
                </div>
                <div class="orbit-2 shrink-90">
                  <o-progress
                    class="shrink-50 angle-0 cyan"
                    value="203"
                    max="255"
                    shape="circle"
                  ></o-progress>
                </div>
              </div>
            </div>
            <div class="satellite angle-105">
              <div class="gravity-spot">
                <div class="orbit-0">
                  <div class="satellite">
                    <div class="capsule">50</div>
                  </div>
                </div>
                <div class="orbit-2 shrink-90">
                  <o-progress
                    class="shrink-50 angle-0 white"
                    value="50"
                    max="255"
                    shape="circle"
                  ></o-progress>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </body>
</html>
